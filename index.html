<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Ambiental ‚Äî Gr√°ficos separados</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase SDK (modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onChildAdded } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // ==== CONFIG FIREBASE (tu proyecto) ====
    const firebaseConfig = {
      apiKey: "AIzaSyDQXRc_tIZFCijDqH54Pcfl9jLQE_-fDKM",
      authDomain: "monitorio-4e133.firebaseapp.com",
      databaseURL: "https://monitorio-4e133-default-rtdb.firebaseio.com",
      projectId: "monitorio-4e133",
      storageBucket: "monitorio-4e133.appspot.com",
      messagingSenderId: "515981874171",
      appId: "1:515981874171:web:98dbf980030fb84e9db15e",
      measurementId: "G-MBWHMXRWBJ"
    };

    // ==== INICIO APP ====
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    const lecturasRef = ref(db, "lecturas");

    // ==== ARRAYS de datos ====
    const MAX_PUNTOS = 60; // √∫ltimos 60 puntos
    const labels = [];

    const tempData = [];
    const humData  = [];
    const presData = [];
    const ruidoData= [];

    // ==== Utilidad: recorta arrays ====
    function trimArrays() {
      const arrs = [labels, tempData, humData, presData, ruidoData];
      arrs.forEach(a => { if (a.length > MAX_PUNTOS) a.shift(); });
    }

    // ==== Crear gr√°ficos (uno por sensor) ====
    function makeLineChart(ctx, label, data) {
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label,
            data,
            fill: false
          }]
        },
        options: {
          responsive: true,
          animation: false,
          interaction: { mode: 'nearest', intersect: false },
          scales: {
            x: { ticks: { autoSkip: true, maxTicksLimit: 8 } }
          }
        }
      });
    }

    // Obtiene contextos
    const ctxTemp  = document.getElementById('chartTemp').getContext('2d');
    const ctxHum   = document.getElementById('chartHum').getContext('2d');
    const ctxPres  = document.getElementById('chartPres').getContext('2d');
    const ctxRuido = document.getElementById('chartRuido').getContext('2d');

    // Crea charts
    const chartTemp  = makeLineChart(ctxTemp,  "Temperatura (¬∞C)", tempData);
    const chartHum   = makeLineChart(ctxHum,   "Humedad (%)",      humData);
    const chartPres  = makeLineChart(ctxPres,  "Presi√≥n (hPa)",    presData);
    const chartRuido = makeLineChart(ctxRuido, "Nivel sonoro (0‚Äì100)", ruidoData);

    // ==== Escuchar nuevas lecturas ====
    onChildAdded(lecturasRef, (snap) => {
      const d = snap.val();
      const now = new Date();
      const hh = now.toLocaleTimeString();

      // Actualiza tarjetas
      if (typeof d.temperatura !== "undefined") document.getElementById("vTemp").textContent  = d.temperatura.toFixed(2) + " ¬∞C";
      if (typeof d.humedad     !== "undefined") document.getElementById("vHum").textContent   = d.humedad.toFixed(2)    + " %";
      if (typeof d.presion     !== "undefined") document.getElementById("vPres").textContent  = d.presion.toFixed(2)    + " hPa";
      if (typeof d.nivel_sonoro!== "undefined") document.getElementById("vRuido").textContent = d.nivel_sonoro.toFixed(2);

      // Push a arrays
      labels.push(hh);
      tempData.push(Number(d.temperatura ?? NaN));
      humData.push(Number(d.humedad ?? NaN));
      presData.push(Number(d.presion ?? NaN));
      ruidoData.push(Number(d.nivel_sonoro ?? NaN));

      trimArrays();

      // Actualiza charts
      chartTemp.update();
      chartHum.update();
      chartPres.update();
      chartRuido.update();
    });
  </script>

  <style>
    :root { --bg:#f6f7fb; --card:#fff; --txt:#1f2937; --muted:#6b7280; }
    * { box-sizing: border-box; }
    body { margin:0; padding:24px; font-family: system-ui, Arial, sans-serif; background: var(--bg); color: var(--txt); }
    h1 { margin: 0 0 16px 0; font-size: 24px; }
    .grid { display: grid; grid-template-columns: repeat(4, minmax(220px, 1fr)); gap: 16px; }
    .card {
      background: var(--card); border-radius: 14px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.06);
    }
    .metric { font-size: 14px; color: var(--muted); }
    .value { font-size: 24px; font-weight: 700; margin-top: 6px; }
    .charts { margin-top: 18px; display:grid; grid-template-columns: repeat(2, minmax(300px,1fr)); gap:16px; }
    canvas { width:100%; height:320px; }
    @media (max-width: 980px){
      .grid { grid-template-columns: 1fr 1fr; }
      .charts { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <h1>Dashboard Ambiental ‚Äî Gr√°ficos por sensor</h1>

  <!-- Tarjetas con valor actual -->
  <div class="grid">
    <div class="card">
      <div class="metric">üå°Ô∏è Temperatura</div>
      <div id="vTemp" class="value">-- ¬∞C</div>
    </div>
    <div class="card">
      <div class="metric">üíß Humedad</div>
      <div id="vHum" class="value">-- %</div>
    </div>
    <div class="card">
      <div class="metric">üìä Presi√≥n</div>
      <div id="vPres" class="value">-- hPa</div>
    </div>
    <div class="card">
      <div class="metric">üîä Nivel sonoro</div>
      <div id="vRuido" class="value">--</div>
    </div>
  </div>

  <!-- Gr√°ficos separados -->
  <div class="charts">
    <div class="card"><canvas id="chartTemp"></canvas></div>
    <div class="card"><canvas id="chartHum"></canvas></div>
    <div class="card"><canvas id="chartPres"></canvas></div>
    <div class="card"><canvas id="chartRuido"></canvas></div>
  </div>
</body>
</html>
