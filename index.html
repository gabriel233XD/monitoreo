<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Ambiental 🌍</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS para exportar a Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root { --card: #fff; --bg: #f2f2f2; --text:#333; }
    body { font-family: Arial, sans-serif; background: var(--bg); color: var(--text); padding: 28px; }
    h1 { display:flex; align-items:center; gap:8px; margin:0 0 16px; }
    h1::before { content:"🌍"; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:12px; }
    .card { background: var(--card); padding:16px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08); font-size:18px; }
    .label { opacity:.7; font-size:14px; display:block; margin-bottom:6px; }
    .value { font-weight:700; font-size:22px; }
    #chartWrap { margin-top:20px; background:var(--card); padding:16px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    button { margin-top:16px; padding:10px 14px; border:none; border-radius:8px; background:#007bff; color:#fff; cursor:pointer; }
    button:hover { filter:brightness(0.95); }
  </style>
</head>
<body>
  <h1>Dashboard Ambiental</h1>

  <div class="grid">
    <div class="card"><span class="label">🌡️ Temperatura</span><span class="value" id="temperatura">-- °C</span></div>
    <div class="card"><span class="label">💧 Humedad</span><span class="value" id="humedad">-- %</span></div>
    <div class="card"><span class="label">📊 Presión</span><span class="value" id="presion">-- hPa</span></div>
    <div class="card"><span class="label">🔊 Nivel Sonoro (Leq 1s)</span><span class="value" id="nivel_sonoro">-- dB</span></div>
    <div class="card"><span class="label">🌞 UV (Voltaje)</span><span class="value" id="uv_volt">-- V</span></div>
    <div class="card"><span class="label">🌤️ UV Index (estimado)</span><span class="value" id="uv_index">--</span></div>
  </div>

  <div id="chartWrap">
    <canvas id="graficoDatos" height="120"></canvas>
  </div>

  <button onclick="exportarExcel()">📁 Exportar a Excel</button>

  <!-- Firebase + lógica -->
  <script type="module">
    // Firebase v10 (modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onChildAdded } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDQXRc_tIZFCijDqH54Pcfl9jLQE_-fDKM",
      authDomain: "monitorio-4e133.firebaseapp.com",
      databaseURL: "https://monitorio-4e133-default-rtdb.firebaseio.com",
      projectId: "monitorio-4e133",
      storageBucket: "monitorio-4e133.appspot.com",
      messagingSenderId: "515981874171",
      appId: "1:515981874171:web:98dbf980030fb84e9db15e",
      measurementId: "G-MBWHMXRWBJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Referencia a la colección de lecturas
    const lecturasRef = ref(db, "lecturas");

    // --- Gráfico ---
    const labels = [];
    const temperaturas = [];
    const humedades = [];
    const presiones = [];
    const sonidos = [];
    const uvis = [];

    const ctx = document.getElementById('graficoDatos').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Temp (°C)', data: temperaturas, borderColor: 'red',   borderWidth: 2, fill: false, tension:.2 },
          { label: 'Humedad (%)', data: humedades, borderColor: 'blue',  borderWidth: 2, fill: false, tension:.2 },
          { label: 'Presión (hPa)', data: presiones, borderColor: 'green', borderWidth: 2, fill: false, tension:.2 },
          { label: 'Leq (dB)', data: sonidos, borderColor: 'orange', borderWidth: 2, fill: false, tension:.2 },
          { label: 'UV Index', data: uvis, borderColor: 'purple', borderWidth: 2, fill: false, tension:.2 },
        ]
      },
      options: {
        responsive: true,
        animation:false,
        plugins: { legend: { position: 'top' } },
        scales: {
          x: { ticks: { autoSkip: true, maxTicksLimit: 8 } }
        }
      }
    });

    // Datos para Excel
    const tablaDatos = [];

    onChildAdded(lecturasRef, (snap) => {
      const d = snap.val();
      // Toma fecha/hora del cliente; si guardas timestamp en Firebase puedes usarlo en su lugar
      const now = new Date();
      const fecha = now.toLocaleDateString();
      const hora  = now.toLocaleTimeString();

      // Actualiza tarjetas (si el campo existe)
      if (d.temperatura !== undefined) document.getElementById('temperatura').textContent = `${Number(d.temperatura).toFixed(2)} °C`;
      if (d.humedad !== undefined)     document.getElementById('humedad').textContent     = `${Number(d.humedad).toFixed(2)} %`;
      if (d.presion !== undefined)     document.getElementById('presion').textContent     = `${Number(d.presion).toFixed(2)} hPa`;
      if (d.nivel_sonoro !== undefined)document.getElementById('nivel_sonoro').textContent= `${Number(d.nivel_sonoro).toFixed(1)} dB`;
      if (d.uv_volt !== undefined)     document.getElementById('uv_volt').textContent     = `${Number(d.uv_volt).toFixed(3)} V`;
      if (d.uv_index !== undefined)    document.getElementById('uv_index').textContent    = `${Number(d.uv_index).toFixed(2)}`;

      // Mantener ventana de los últimos 50 puntos
      const label = `${hora.split(' ')[0]}`; // solo hora
      if (labels.length >= 50) {
        labels.shift(); temperaturas.shift(); humedades.shift(); presiones.shift(); sonidos.shift(); uvis.shift();
      }
      labels.push(label);
      temperaturas.push(Number(d.temperatura ?? NaN));
      humedades.push(Number(d.humedad ?? NaN));
      presiones.push(Number(d.presion ?? NaN));
      sonidos.push(Number(d.nivel_sonoro ?? NaN));
      uvis.push(Number(d.uv_index ?? NaN));
      chart.update();

      // Guardar fila para Excel
      tablaDatos.push({
        Fecha: fecha,
        Hora: hora,
        Temperatura: Number(d.temperatura ?? ''),
        Humedad: Number(d.humedad ?? ''),
        Presion: Number(d.presion ?? ''),
        NivelSonoro_dB: Number(d.nivel_sonoro ?? ''),
        UV_Volt: Number(d.uv_volt ?? ''),
        UV_Index: Number(d.uv_index ?? '')
      });
    });

    // Exportar a Excel
    window.exportarExcel = () => {
      const ws = XLSX.utils.json_to_sheet(tablaDatos);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Lecturas");
      XLSX.writeFile(wb, "datos_ambientales.xlsx");
    };
  </script>
</body>
</html>

