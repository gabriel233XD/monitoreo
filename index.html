<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>SensorEdu</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS (Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{ --bg:#f6f7fb; --card:#fff; --txt:#1f2937; --muted:#6b7280; --accent:#0ea5e9; --shadow:0 6px 20px rgba(0,0,0,.06); }
    *{ box-sizing:border-box }
    body{ margin:0; padding:24px; font-family:system-ui,Segoe UI,Arial,sans-serif; background:var(--bg); color:var(--txt) }
    header{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px }
    h1{ margin:0; font-size:22px }
    .btn{ padding:10px 14px; border:0; border-radius:10px; background:var(--accent); color:#fff; cursor:pointer; box-shadow:var(--shadow) }
    .grid{ display:grid; grid-template-columns:repeat(4,minmax(220px,1fr)); gap:16px }
    .card{ background:var(--card); border-radius:16px; padding:16px; box-shadow:var(--shadow) }
    .metric{ font-size:13px; color:var(--muted) }
    .value{ font-size:26px; font-weight:800; margin-top:6px }
    .charts{ margin-top:16px; display:grid; grid-template-columns:repeat(2,minmax(300px,1fr)); gap:16px }
    canvas{ width:100%; height:320px }
    @media (max-width: 1000px){ .grid{grid-template-columns:1fr 1fr} .charts{grid-template-columns:1fr} }
    @media (max-width: 640px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <h1>SensorEdu</h1>
    <button id="btnExcel" class="btn">üì• Descargar Excel</button>
  </header>

  <!-- Tarjetas -->
  <section class="grid">
    <div class="card"><div class="metric">üå°Ô∏è Temperatura</div><div id="vTemp" class="value">-- ¬∞C</div></div>
    <div class="card"><div class="metric">üíß Humedad</div><div id="vHum"  class="value">-- %</div></div>
    <div class="card"><div class="metric">üìä Presi√≥n</div><div id="vPres" class="value">-- hPa</div></div>
    <div class="card"><div class="metric">üîä Nivel sonoro (0‚Äì100)</div><div id="vRuido" class="value">--</div></div>
  </section>

  <!-- Gr√°ficos separados (sin tiempo, solo √≠ndice de muestra) -->
  <section class="charts">
    <div class="card"><canvas id="chartTemp"></canvas></div>
    <div class="card"><canvas id="chartHum"></canvas></div>
    <div class="card"><canvas id="chartPres"></canvas></div>
    <div class="card"><canvas id="chartRuido"></canvas></div>
  </section>

  <!-- Firebase + L√≥gica -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onChildAdded, get, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Config Firebase (tu proyecto)
    const firebaseConfig = {
      apiKey: "AIzaSyDQXRc_tIZFCijDqH54Pcfl9jLQE_-fDKM",
      authDomain: "monitorio-4e133.firebaseapp.com",
      databaseURL: "https://monitorio-4e133-default-rtdb.firebaseio.com",
      projectId: "monitorio-4e133",
      storageBucket: "monitorio-4e133.appspot.com",
      messagingSenderId: "515981874171",
      appId: "1:515981874171:web:98dbf980030fb84e9db15e",
      measurementId: "G-MBWHMXRWBJ"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    const lecturasRef = ref(db, "lecturas");

    // Buffers para charts
    const MAX_PUNTOS = 200;     // cu√°ntos puntos mantener
    const labels = [];          // √≠ndice de muestra (no tiempo)
    let sampleIndex = 0;

    const tempData = [], humData = [], presData = [], ruidoData = [];

    // Datos para Excel
    const tablaDatos = []; // {fecha, hora, temperatura, humedad, presion, nivel_sonoro}

    function trim(arr){ if(arr.length > MAX_PUNTOS) arr.shift(); }
    function trimAll(){
      trim(labels); trim(tempData); trim(humData); trim(presData); trim(ruidoData);
    }

    // Crear charts
    function makeChart(canvasId, label, data){
      return new Chart(document.getElementById(canvasId).getContext('2d'), {
        type:'line',
        data:{ labels, datasets:[{ label, data, fill:false }] },
        options:{
          responsive:true,
          animation:false,
          scales:{
            x:{ title:{ display:true, text:'Muestra' } }
          }
        }
      });
    }

    const chartTemp  = makeChart('chartTemp','Temperatura (¬∞C)', tempData);
    const chartHum   = makeChart('chartHum','Humedad (%)', humData);
    const chartPres  = makeChart('chartPres','Presi√≥n (hPa)', presData);
    const chartRuido = makeChart('chartRuido','Nivel sonoro (0‚Äì100)', ruidoData);

    // Escuchar nuevas lecturas
    onChildAdded(lecturasRef, (snap)=>{
      const d = snap.val() || {};

      // Mostrar en tarjetas
      if(d.temperatura!=null) document.getElementById("vTemp").textContent  = `${Number(d.temperatura).toFixed(2)} ¬∞C`;
      if(d.humedad!=null)     document.getElementById("vHum").textContent   = `${Number(d.humedad).toFixed(2)} %`;
      if(d.presion!=null)     document.getElementById("vPres").textContent  = `${Number(d.presion).toFixed(2)} hPa`;
      if(d.nivel_sonoro!=null)document.getElementById("vRuido").textContent = `${Number(d.nivel_sonoro).toFixed(2)}`;

      // Eje X por √≠ndice de muestra
      labels.push(++sampleIndex);

      // Alimentar series
      tempData.push(Number(d.temperatura ?? NaN));
      humData.push(Number(d.humedad ?? NaN));
      presData.push(Number(d.presion ?? NaN));
      ruidoData.push(Number(d.nivel_sonoro ?? NaN));
      trimAll();

      // Guardar fila para Excel (usa fecha/hora del ESP32 si vienen; si no, genera ahora)
      const now = new Date();
      const fechaGen = now.toISOString().slice(0,10); // YYYY-MM-DD
      const horaGen  = now.toTimeString().slice(0,8); // HH:MM:SS
      tablaDatos.push({
        fecha: d.fecha ?? fechaGen,
        hora:  d.hora  ?? horaGen,
        temperatura: d.temperatura ?? "",
        humedad:     d.humedad ?? "",
        presion:     d.presion ?? "",
        nivel_sonoro:d.nivel_sonoro ?? ""
      });

      // Actualizar gr√°ficos
      chartTemp.update(); chartHum.update(); chartPres.update(); chartRuido.update();
    });

    // Exportar a Excel (incluye Fecha y Hora)
    document.getElementById("btnExcel").addEventListener("click", async ()=>{
      // Si quieres cargar TODO antes de exportar:
      // const snap = await get(child(ref(db),"lecturas")); // opcional para traer hist√≥rico
      // (usamos tablaDatos en memoria con lo que se haya recibido)
      if(!tablaDatos.length){
        alert("A√∫n no hay datos para exportar.");
        return;
      }
      const filas = [["Fecha","Hora","Temperatura (¬∞C)","Humedad (%)","Presi√≥n (hPa)","Nivel sonoro"]];
      tablaDatos.forEach(r=>{
        filas.push([r.fecha, r.hora, r.temperatura, r.humedad, r.presion, r.nivel_sonoro]);
      });
      const ws = XLSX.utils.aoa_to_sheet(filas);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Lecturas");
      XLSX.writeFile(wb, "datos_ambientales.xlsx");
    });
  </script>
</body>
</html>
