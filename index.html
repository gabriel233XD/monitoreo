<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SensorEdu</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- SheetJS (Excel) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --bg:#0b1020; --panel:#0f172a; --card:#11172a; --txt:#e5e7eb; --muted:#94a3b8;
    --primary:#22d3ee; --ring:#1f2937; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    --shadow:0 20px 40px rgba(2,6,23,.25);
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f6f7fb; --panel:#f1f5f9; --card:#ffffff; --txt:#0f172a; --muted:#64748b;
      --primary:#0891b2; --ring:#e2e8f0; --shadow:0 12px 30px rgba(2,6,23,.06);
    }
  }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--txt); font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
  .app{max-width:1200px; margin:0 auto; padding:20px}
  header{
    position:sticky; top:0; z-index:20; backdrop-filter: blur(8px);
    background: color-mix(in oklab, var(--panel) 85%, transparent);
    border:1px solid var(--ring); border-radius:16px; padding:12px 16px; box-shadow: var(--shadow);
    display:flex; align-items:center; gap:16px; justify-content:space-between; margin-bottom:16px;
  }
  .brand{display:flex; align-items:center; gap:12px}
  .logo{
    width:34px; height:34px; border-radius:10px; background: radial-gradient(120% 120% at 0% 0%, var(--primary), #6ee7b7);
    box-shadow: inset 0 0 0 1px #ffffff22, 0 10px 20px #22d3ee33;
  }
  h1{font-size:18px; margin:0}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  .btn{
    border:1px solid var(--ring); background:linear-gradient(180deg, var(--card), color-mix(in oklab, var(--card) 80%, #0000));
    color:var(--txt); padding:10px 14px; border-radius:12px; cursor:pointer; transition:transform .05s ease; box-shadow: var(--shadow);
  }
  .btn:hover{transform: translateY(-1px)}
  .btn.primary{border-color: color-mix(in oklab, var(--primary) 60%, var(--ring)); background: color-mix(in oklab, var(--primary) 15%, var(--card));}
  .btn.ghost{background:transparent}
  .grid{display:grid; grid-template-columns: repeat(4, minmax(220px,1fr)); gap:16px}
  .card{
    background: linear-gradient(180deg, var(--card), color-mix(in oklab, var(--card) 80%, #0000));
    border:1px solid var(--ring); border-radius:18px; padding:16px; box-shadow: var(--shadow);
  }
  .metric{font-size:12px; color:var(--muted); display:flex; align-items:center; gap:8px}
  .chip{font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--ring); color:var(--muted)}
  .chip.ok{color:var(--ok); border-color: color-mix(in oklab, var(--ok) 60%, var(--ring)); background: color-mix(in oklab, var(--ok) 15%, transparent)}
  .chip.warn{color:var(--warn); border-color: color-mix(in oklab, var(--warn) 60%, var(--ring)); background: color-mix(in oklab, var(--warn) 15%, transparent)}
  .chip.bad{color:var(--bad); border-color: color-mix(in oklab, var(--bad) 60%, var(--ring)); background: color-mix(in oklab, var(--bad) 15%, transparent)}
  .value{font-size:28px; font-weight:800; margin-top:8px}
  .hint{margin-top:8px; font-size:12px; color:var(--muted)}
  .charts{margin-top:16px; display:grid; grid-template-columns: repeat(2, minmax(300px,1fr)); gap:16px}
  canvas{width:100%; height:320px}
  .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .ring{outline:2px solid transparent}
  .alert{outline:2px solid var(--bad); outline-offset: -1px}
  footer{margin-top:18px; color:var(--muted); font-size:12px; text-align:center}

  .filter-bar{margin:12px 0; display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .input{appearance:none; border:1px solid var(--ring); background:var(--card); color:var(--txt);
    padding:10px 12px; border-radius:12px; box-shadow: var(--shadow); }
  @media (max-width: 1000px){ .grid, .charts{grid-template-columns: 1fr 1fr} }
  @media (max-width: 640px){ .grid, .charts{grid-template-columns: 1fr} .toolbar{justify-content:center} }
</style>
</head>
<body>
<div class="app">

  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>SensorEdu</h1>
        <div style="font-size:12px; color:var(--muted)">Monitoreo ambiental en tiempo real</div>
      </div>
    </div>
    <div class="toolbar">
      <button id="btnExcel" class="btn primary">üì• Excel</button>
      <button id="btnTheme" class="btn ghost">üåì Tema</button>
    </div>
  </header>

  <!-- Tarjetas / KPIs -->
  <section class="grid">
    <div id="cardTemp" class="card ring">
      <div class="metric">üå°Ô∏è Temperatura <span id="chipTemp" class="chip">‚Äî</span></div>
      <div id="vTemp" class="value">‚Äî ¬∞C</div>
      <div class="hint">Umbral alto: <input id="thrTemp" class="input" type="number" value="30" style="width:90px"> ¬∞C</div>
    </div>
    <div id="cardHum" class="card ring">
      <div class="metric">üíß Humedad <span id="chipHum" class="chip">‚Äî</span></div>
      <div id="vHum" class="value">‚Äî %</div>
      <div class="hint">Umbral bajo: <input id="thrHum" class="input" type="number" value="25" style="width:90px"> %</div>
    </div>
    <div id="cardPres" class="card ring">
      <div class="metric">üìä Presi√≥n <span id="chipPres" class="chip">‚Äî</span></div>
      <div id="vPres" class="value">‚Äî hPa</div>
      <div class="hint">Rango t√≠pico: 980‚Äì1030 hPa</div>
    </div>
    <div id="cardNoise" class="card ring">
      <div class="metric">üîä Nivel sonoro (0‚Äì100) <span id="chipNoise" class="chip">‚Äî</span></div>
      <div id="vNoise" class="value">‚Äî</div>
      <div class="hint">Umbral alto: <input id="thrNoise" class="input" type="number" value="70" style="width:90px"></div>
    </div>
  </section>

  <!-- Filtro por fecha (opcional) -->
  <div class="card filter-bar">
    <strong>Filtrar por fecha</strong>
    <span style="font-size:12px; color:var(--muted)">(Usa campos <code>fecha</code> y <code>hora</code> si tu ESP32 los env√≠a)</span>
    <input type="date" id="fromDate" class="input" />
    <input type="date" id="toDate" class="input" />
    <button id="btnFiltrar" class="btn">Aplicar</button>
    <span id="filterWarn" style="font-size:12px; color:var(--muted)"></span>
  </div>

  <!-- Gr√°ficos -->
  <section class="charts">
    <div class="card ring"><canvas id="chartTemp"></canvas></div>
    <div class="card ring"><canvas id="chartHum"></canvas></div>
    <div class="card ring"><canvas id="chartPres"></canvas></div>
    <div class="card ring"><canvas id="chartNoise"></canvas></div>
  </section>

  <footer>¬© SensorEdu ‚Äî hecho con ESP32 + Firebase</footer>

</div>

<script type="module">
  // Tema claro/oscuro con persistencia
  const btnTheme = document.getElementById('btnTheme');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const storedTheme = localStorage.getItem('theme');
  if(storedTheme){ document.documentElement.style.colorScheme = storedTheme; }
  else{ document.documentElement.style.colorScheme = prefersDark ? 'dark' : 'light'; }
  btnTheme.onclick = ()=>{
    const current = document.documentElement.style.colorScheme || (prefersDark?'dark':'light');
    const next = current === 'dark' ? 'light' : 'dark';
    document.documentElement.style.colorScheme = next;
    localStorage.setItem('theme', next);
    location.reload(); // refrescar colores de charts
  };

  // Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, onChildAdded, get, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDQXRc_tIZFCijDqH54Pcfl9jLQE_-fDKM",
    authDomain: "monitorio-4e133.firebaseapp.com",
    databaseURL: "https://monitorio-4e133-default-rtdb.firebaseio.com",
    projectId: "monitorio-4e133",
    storageBucket: "monitorio-4e133.appspot.com",
    messagingSenderId: "515981874171",
    appId: "1:515981874171:web:98dbf980030fb84e9db15e",
    measurementId: "G-MBWHMXRWBJ"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  const lecturasRef = ref(db, "lecturas");

  // Buffers
  const labels=[], tData=[], hData=[], pData=[], nData=[];
  const tableRows = []; // {fecha, hora, temperatura, humedad, presion, nivel_sonoro}
  let sample = 0;

  // Funciones utilitarias
  const trimTo = (arr, max) => { if(arr.length>max) arr.splice(0, arr.length-max); };
  const MAX_POINTS = 200; // fijo (ya quitamos el selector de puntos)
  const setText = (id,v)=>document.getElementById(id).textContent=v;

  // Charts
  const mkChart = (id, label, data)=> new Chart(document.getElementById(id), {
    type:'line',
    data:{ labels, datasets:[{ label, data, borderWidth:2, pointRadius:0, tension:.25, fill:false }] },
    options:{
      responsive:true, animation:false,
      plugins:{ legend:{ labels:{ color:getComputedStyle(document.body).color } } },
      scales:{
        x:{ title:{ display:true, text:'Muestra', color:getComputedStyle(document.body).color },
            grid:{ color:getComputedStyle(document.body).color+'22' },
            ticks:{ color:getComputedStyle(document.body).color }
        },
        y:{ grid:{ color:getComputedStyle(document.body).color+'22' },
            ticks:{ color:getComputedStyle(document.body).color }
        }
      }
    }
  });

  const cTemp  = mkChart('chartTemp','Temperatura (¬∞C)', tData);
  const cHum   = mkChart('chartHum','Humedad (%)', hData);
  const cPres  = mkChart('chartPres','Presi√≥n (hPa)', pData);
  const cNoise = mkChart('chartNoise','Nivel sonoro (0‚Äì100)', nData);

  // Umbrales y elementos UI
  const thrTemp  = document.getElementById('thrTemp');
  const thrHum   = document.getElementById('thrHum');
  const thrNoise = document.getElementById('thrNoise');

  const vTemp=document.getElementById('vTemp'), vHum=document.getElementById('vHum'), vPres=document.getElementById('vPres'), vNoise=document.getElementById('vNoise');
  const cardTemp=document.getElementById('cardTemp'), cardHum=document.getElementById('cardHum'), cardPres=document.getElementById('cardPres'), cardNoise=document.getElementById('cardNoise');
  const chipTemp=document.getElementById('chipTemp'), chipHum=document.getElementById('chipHum'), chipPres=document.getElementById('chipPres'), chipNoise=document.getElementById('chipNoise');

  const setChip=(chip, state)=>{
    chip.className = 'chip ' + (state||'ok');
    chip.textContent = state==='bad' ? 'Alerta' : state==='warn' ? 'Atenci√≥n' : 'OK';
  };
  const setAlert=(card, chip, state)=>{
    card.classList.remove('alert');
    setChip(chip, state);
    if(state==='bad') card.classList.add('alert');
  };

  // Realtime listener
  onChildAdded(lecturasRef, (snap)=>{
    const d = snap.val() || {};

    // tarjetas
    if(d.temperatura!=null) vTemp.textContent  = `${Number(d.temperatura).toFixed(2)} ¬∞C`;
    if(d.humedad!=null)     vHum.textContent   = `${Number(d.humedad).toFixed(2)} %`;
    if(d.presion!=null)     vPres.textContent  = `${Number(d.presion).toFixed(2)} hPa`;
    if(d.nivel_sonoro!=null)vNoise.textContent = `${Number(d.nivel_sonoro).toFixed(2)}`;

    // labels & series
    labels.push(++sample);
    tData.push(Number(d.temperatura ?? NaN));
    hData.push(Number(d.humedad ?? NaN));
    pData.push(Number(d.presion ?? NaN));
    nData.push(Number(d.nivel_sonoro ?? NaN));
    [labels,tData,hData,pData,nData].forEach(a=>trimTo(a, MAX_POINTS));

    // alertas
    const t=+d.temperatura, h=+d.humedad, p=+d.presion, n=+d.nivel_sonoro;
    if(!isNaN(t)) setAlert(cardTemp, chipTemp, (t>=(+thrTemp.value||30)) ? 'bad' : 'ok');
    if(!isNaN(h)) setAlert(cardHum,  chipHum,  (h<=(+thrHum.value||25)) ? 'warn': 'ok');
    if(!isNaN(p)) setAlert(cardPres, chipPres, (p<980||p>1030) ? 'warn' : 'ok');
    if(!isNaN(n)) setAlert(cardNoise,chipNoise,(n>=(+thrNoise.value||70)) ? 'bad' : 'ok');

    // tabla (Excel) ‚Äî genera fecha/hora si no vienen del ESP32
    const now = new Date();
    const fecha = d.fecha ?? now.toISOString().slice(0,10); // YYYY-MM-DD
    const hora  = d.hora  ?? now.toTimeString().slice(0,8); // HH:MM:SS
    tableRows.push({
      fecha, hora,
      temperatura: d.temperatura ?? '',
      humedad:     d.humedad ?? '',
      presion:     d.presion ?? '',
      nivel_sonoro:d.nivel_sonoro ?? ''
    });

    // actualizar charts
    cTemp.update(); cHum.update(); cPres.update(); cNoise.update();
  });

  // Excel
  document.getElementById('btnExcel').onclick = ()=>{
    if(!tableRows.length){ alert('A√∫n no hay datos para exportar.'); return; }
    const rows = [["Fecha","Hora","Temperatura (¬∞C)","Humedad (%)","Presi√≥n (hPa)","Nivel sonoro"]];
    tableRows.forEach(r=> rows.push([r.fecha, r.hora, r.temperatura, r.humedad, r.presion, r.nivel_sonoro]));
    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Lecturas');
    XLSX.writeFile(wb, 'SensorEdu_lecturas.xlsx');
  };

  // Filtro por fecha (informativo; no rehace las series en vivo)
  document.getElementById('btnFiltrar').onclick = ()=>{
    const fd = document.getElementById("fromDate").value;
    const td = document.getElementById("toDate").value;
    const warn = document.getElementById("filterWarn");

    if(!fd || !td){ warn.textContent="Selecciona fecha de inicio y fin."; return; }
    const rows = tableRows.filter(r=> r.fecha && r.fecha >= fd && r.fecha <= td);
    warn.textContent = rows.length ? `Registros en rango: ${rows.length}.` : "No hay registros para ese rango.";
  };
</script>
</body>
</html>
